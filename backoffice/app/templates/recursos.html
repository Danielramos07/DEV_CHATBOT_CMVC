{% extends "base_admin.html" %} {% block title %}Chatbot Municipal - Recursos{%
endblock %} {% block extra_head %}
<link
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
  rel="stylesheet"
/>
{% endblock %} {% block menu_recursos_class %}active{% endblock %} {% block
content %}
<div class="panel">
  <div id="indicadorAtivo" style="display: none" class="ativo-indicador"></div>
  <div id="secaoRecursos" class="secao left-content">
    <h2>CMVC: Listagem dos Assistentes Virtuais</h2>
    <div class="filtros-bots-bar">
      <input id="filtroNomeBot" type="text" placeholder="Filtrar por nome" />
      <select id="filtroEstadoBot">
        <option value="todos">Todos os estados</option>
        <option value="ativo">Ativo</option>
        <option value="nao_publicado">Não Publicado</option>
      </select>
      <input id="filtroDataCriacaoBot" type="date" placeholder="dd/mm/aaaa" />
    </div>
    <button id="novoBotBtn" class="btn-novo-bot-main">+ Novo Bot</button>
    <div id="botsTabelaContainer" style="margin-top: 24px"></div>
  </div>
</div>

<!-- Modal Novo Chatbot -->
<div
  id="modalNovoBot"
  class="modal-overlay modal-overlay-novo-bot"
  style="display: none"
>
  <div class="modal-box modal-box-novo-bot-exclusivo">
    <h2>Novo Chatbot</h2>
    <form id="novoBotForm" enctype="multipart/form-data">
      <input type="text" name="nome" placeholder="Nome do Chatbot" required />
      <textarea name="descricao" placeholder="Descrição"></textarea>
      <div class="form-group">
        <label for="novoGeneroChatbot">Género do Bot:</label>
        <select name="genero" id="novoGeneroChatbot">
          <option value="">Neutro</option>
          <option value="m">Masculino</option>
          <option value="f">Feminino</option>
        </select>
      </div>
      <div class="form-group">
        <label for="novaMensagemSemResposta"
          >Mensagem personalizada "Sem Resposta":</label
        >
        <textarea
          name="mensagem_sem_resposta"
          id="novaMensagemSemResposta"
          placeholder="Mensagem apresentada quando não há resposta..."
          rows="2"
        ></textarea>
      </div>
      <div class="form-group">
        <label class="cor-bot-label" for="novaCorChatbot">
          <span>Cor do Bot:</span>
          <input
            type="color"
            name="cor"
            id="novaCorChatbot"
            value="#d4af37"
            style="
              width: 48px;
              height: 48px;
              min-width: 48px;
              max-width: 48px;
            "
          />
        </label>
      </div>
      <div class="form-group">
        <label for="novoIconChatbot">Ícone (avatar):</label>
        <input type="file" name="icon" id="novoIconChatbot" accept="image/*" />
        <input type="hidden" name="icon_preset" id="novoIconPreset" value="" />
        <div style="margin-top: 10px">Avatares pré-definidos:</div>
        <div
          id="avatarPresets"
          style="
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            margin-top: 8px;
            padding: 6px 8px 10px 12px;
            align-items: center;
          "
        >
          <button
            type="button"
            class="avatar-preset"
            data-avatar="face.jpg"
            style="
              border: none;
              background: transparent;
              padding: 0;
              cursor: pointer;
              flex: 0 0 auto;
              display: inline-flex;
              width: 48px;
              height: 48px;
              min-width: 48px;
              max-width: 48px;
              align-items: center;
              justify-content: center;
              overflow: hidden;
            "
          >
            <img
              src="/static/images/avatars/face.jpg"
              alt="Avatar 1"
              style="
                width: 48px;
                height: 48px;
                border-radius: 10px;
                object-fit: cover;
              "
            />
          </button>
          <button
            type="button"
            class="avatar-preset"
            data-avatar="face2.png"
            style="
              border: none;
              background: transparent;
              padding: 0;
              cursor: pointer;
              flex: 0 0 auto;
              display: inline-flex;
              width: 48px;
              height: 48px;
              min-width: 48px;
              max-width: 48px;
              align-items: center;
              justify-content: center;
              overflow: hidden;
            "
          >
            <img
              src="/static/images/avatars/face2.png"
              alt="Avatar 2"
              style="
                width: 48px;
                height: 48px;
                border-radius: 10px;
                object-fit: cover;
              "
            />
          </button>
          <button
            type="button"
            class="avatar-preset"
            data-avatar="face3.png"
            style="
              border: none;
              background: transparent;
              padding: 0;
              cursor: pointer;
              flex: 0 0 auto;
              display: inline-flex;
              width: 48px;
              height: 48px;
              min-width: 48px;
              max-width: 48px;
              align-items: center;
              justify-content: center;
              overflow: hidden;
            "
          >
            <img
              src="/static/images/avatars/face3.png"
              alt="Avatar 3"
              style="
                width: 48px;
                height: 48px;
                border-radius: 10px;
                object-fit: cover;
              "
            />
          </button>
          <button
            type="button"
            class="avatar-preset"
            data-avatar="face4.png"
            style="
              border: none;
              background: transparent;
              padding: 0;
              cursor: pointer;
              flex: 0 0 auto;
              display: inline-flex;
              width: 48px;
              height: 48px;
              min-width: 48px;
              max-width: 48px;
              align-items: center;
              justify-content: center;
              overflow: hidden;
            "
          >
            <img
              src="/static/images/avatars/face4.png"
              alt="Avatar 4"
              style="
                width: 48px;
                height: 48px;
                border-radius: 10px;
                object-fit: cover;
              "
            />
          </button>
          <button
            type="button"
            class="avatar-preset"
            data-avatar="face5.png"
            style="
              border: none;
              background: transparent;
              padding: 0;
              cursor: pointer;
              flex: 0 0 auto;
              display: inline-flex;
              width: 48px;
              height: 48px;
              min-width: 48px;
              max-width: 48px;
              align-items: center;
              justify-content: center;
              overflow: hidden;
            "
          >
            <img
              src="/static/images/avatars/face5.png"
              alt="Avatar 5"
              style="
                width: 48px;
                height: 48px;
                border-radius: 10px;
                object-fit: cover;
              "
            />
          </button>
        </div>
      </div>
      <label class="video-enabled-row">
        <input type="checkbox" name="video_enabled" />
        <span
          >Ativar vídeos do avatar (gerar greeting + idle automaticamente)</span
        >
      </label>
      <div class="btn-bar-novo-bot">
        <button type="submit" class="btn-novo-bot-modal">Criar Chatbot</button>
        <button
          type="button"
          onclick="fecharModalNovoBot()"
          class="btn-cancelar-novo-bot"
        >
          Cancelar
        </button>
      </div>
      <div id="mensagemNovoBot" style="margin-top: 8px"></div>
    </form>
  </div>
</div>
<!-- Modal Editar Chatbot -->
<div
  id="modalEditarChatbot"
  class="modal-overlay modal-overlay-editar-chatbot"
  style="display: none"
>
  <div class="modal-box modal-box-editar-chatbot-exclusivo">
    <h2>Editar Chatbot</h2>
    <form id="editarChatbotForm" enctype="multipart/form-data">
      <div class="grid-row">
        <div class="form-group">
          <label for="editarNomeChatbot">Nome:</label>
          <input type="text" name="nome" id="editarNomeChatbot" required />
        </div>
        <div class="form-group form-group-descricao">
          <label for="editarDescricaoChatbot">Descrição:</label>
          <input type="text" name="descricao" id="editarDescricaoChatbot" />
        </div>
      </div>
      <div class="grid-row">
        <div class="form-group">
          <label for="editarDataCriacao">Data de Criação:</label>
          <input
            type="text"
            id="editarDataCriacao"
            disabled
            style="background: #eee; color: #666"
          />
        </div>
        <div class="form-group">
          <label for="editarFonteResposta">Fonte de Resposta:</label>
          <select name="fonte" id="editarFonteResposta" required>
            <option value="faq">Baseado em Regras (FAQ)</option>
            <option value="faiss">FAISS</option>
                width: 48px;
                height: 48px;
                min-width: 48px;
                max-width: 48px;
      <div class="grid-row">
        <div class="form-group">
          <label for="editarGeneroChatbot">Género do Bot:</label>
          <select name="genero" id="editarGeneroChatbot">
            <option value="">Neutro</option>
            <option value="m">Masculino</option>
            <option value="f">Feminino</option>
          </select>
        </div>
                  width: 48px;
                  height: 48px;
        <div class="form-group">
          <label for="editarVideoEnabledChatbot">
            <input
              type="checkbox"
              name="video_enabled"
              id="editarVideoEnabledChatbot"
              style="width: 18px; height: 18px; margin-right: 6px"
            />
            Ativar geração de vídeo (SadTalker) para este chatbot
          </label>
        </div>
      </div>
      <div class="form-group">
        <label for="editarMensagemSemResposta"
          >Mensagem personalizada "Sem Resposta":</label
        >
        <textarea
          name="mensagem_sem_resposta"
          id="editarMensagemSemResposta"
          placeholder="Mensagem apresentada quando não há resposta..."
          rows="2"
        ></textarea>
      </div>
      <div class="form-group">
        <label class="cor-bot-label" for="editarCorChatbot">
          <span>Cor do Bot:</span>
          <input
            type="color"
            name="cor"
            id="editarCorChatbot"
            value="#d4af37"
            style="
              width: 38px;
              height: 28px;
              border-radius: 8px;
              border: 1px solid #ccc;
            "
          />
        </label>
      </div>
      <div class="form-group">
        <label for="editarIconChatbot">Ícone:</label>
        <input
          type="file"
          name="icon"
          id="editarIconChatbot"
          accept="image/*"
        />
        <img
          id="previewIcon"
          src=""
          alt="Preview Ícone"
          style="
            width: 50px;
            height: 50px;
            margin-top: 5px;
            display: none;
            border-radius: 4px;
            object-fit: cover;
          "
        />
      </div>
      <div class="form-group-categorias">
        <label id="editarCategoriasChatbot-label">Categorias:</label>
        <div
          id="editarCategoriasChatbotView"
          class="categorias-list-view"
          aria-labelledby="editarCategoriasChatbot-label"
        ></div>
      </div>
      <div class="btn-bar-editar-bot">
        <button type="submit" class="btn-atualizar-editar-bot">
          Atualizar
        </button>
        <button
          type="button"
          onclick="fecharModalEditarChatbot()"
          class="btn-fechar-editar-bot"
        >
          Fechar
        </button>
      </div>
      <div id="editarChatbotStatus" style="margin-top: 8px"></div>
    </form>
  </div>
</div>
<!-- Modal Adicionar FAQ -->
<div
  id="modalAdicionarFAQ"
  class="modal-overlay modal-overlay-adicionar-faq"
  style="display: none"
>
  <div class="modal-box modal-box-adicionar-faq-exclusivo">
    <h2>Adicionar Documentos para FAQ</h2>
    <div class="modal-content-grid">
      <div class="form-container">
        <h3 class="section-title">Adicionar FAQ</h3>
        <form id="formAdicionarFAQ" class="faqForm">
          <input type="hidden" name="chatbot_id" id="faqChatbotId" />
          <input
            type="text"
            name="identificador"
            placeholder="Identificador "
            maxlength="120"
          />
          <input
            type="text"
            name="designacao"
            placeholder="Designação"
            required
          />
          <input type="text" name="pergunta" placeholder="Pergunta" required />
          <textarea
            name="serve_text"
            placeholder="Serve / A quem se destina..."
            rows="5"
            style="min-height: 120px"
          ></textarea>
          <textarea
            name="resposta"
            placeholder="Resposta"
            required
            rows="8"
            style="min-height: 180px"
          ></textarea>
          <select name="categoria_id" id="faqCategoriaSelect" required>
            <option value="">Escolha a categoria</option>
          </select>
          <select name="idioma" id="faqIdiomaSelect" required>
            <option value="">Escolha o idioma</option>
            <option value="pt">Português</option>
            <option value="en">Inglês</option>
          </select>
          <div class="links-docs-group">
            <label class="links-docs-label">Links de documentos</label>
            <div id="faqLinksContainer" class="links-docs-container">
              <div class="link-doc-row">
                <input
                  type="url"
                  name="links_documentos[]"
                  class="link-doc-input"
                  placeholder="https://exemplo.com/documento.pdf"
                />
                <button
                  type="button"
                  class="btn-remover-link"
                  title="Remover"
                  disabled
                >
                  ×
                </button>
              </div>
            </div>
            <button type="button" id="faqAddLinkBtn" class="btn-adicionar-link">
              + Adicionar link
            </button>
            <small class="form-text"
              >Um link por campo. Não é preciso usar vírgulas.</small
            >
          </div>
          <div class="form-group">
            <label for="faqRelacionadasSelect">FAQs relacionadas</label>
            <select
              id="faqRelacionadasSelect"
              name="relacionadas[]"
              class="form-select"
              multiple
            ></select>
            <small class="form-text">
              Pode selecionar várias FAQs e escrever para pesquisar.
            </small>
          </div>
          <button
            type="submit"
            class="btn-adicionar-faq-modal"
            style="margin-bottom: 8px"
          >
            Adicionar FAQ
          </button>
          <div
            id="mensagemFAQ"
            style="font-weight: 500; margin-bottom: 8px; text-align: center"
          ></div>
        </form>
      </div>
      <div class="upload-container">
        <h3 class="section-title">Adicionar Documentos para FAQ</h3>
        <div class="divider-text">Ou</div>
        <form
          id="formUploadDocxFAQ"
          class="uploadForm"
          enctype="multipart/form-data"
          style="margin-bottom: 0"
        >
          <input type="hidden" name="chatbot_id" id="docxChatbotId" />
          <input
            type="file"
            name="files"
            id="docxFilesInput"
            accept=".docx"
            multiple
            required
          />
          <button type="submit" class="btn-adicionar-docx-modal">
            Adicionar Documento(s) .docx
          </button>
          <div
            class="uploadStatus"
            style="margin-top: 8px; min-height: 20px"
          ></div>
        </form>
        <h3 class="section-title">Adicionar Documentos para RAG</h3>
        <form
          id="formUploadPDFFAQ"
          class="uploadForm"
          enctype="multipart/form-data"
          style="margin-bottom: 0; margin-top: 12px"
        >
          <input type="hidden" name="chatbot_id" id="pdfChatbotId" />
          <input
            type="file"
            name="file"
            id="pdfFilesInput"
            accept=".pdf"
            multiple
            required
          />
          <button
            type="submit"
            class="btn-adicionar-pdf-modal btn-adicionar-faq-modal"
          >
            Adicionar Documento(s) .PDF
          </button>
          <div
            class="uploadStatusPDF"
            style="margin-top: 8px; min-height: 20px"
          ></div>
        </form>
      </div>
    </div>
    <div class="btn-bar-adicionar-faq" style="margin-top: 14px">
      <button
        type="button"
        onclick="fecharModalAdicionarFAQ()"
        class="btn-cancelar-adicionar-faq"
      >
        Fechar
      </button>
    </div>
  </div>
</div>
<div id="modalVideoBusy" class="modal-overlay" style="display: none">
  <div class="modal-box modal-box-confirmacao">
    <p id="modalVideoBusyMsg">
      Já existe um vídeo a ser gerado neste momento. Aguarde que termine.
    </p>
    <div class="modal-buttons">
      <button onclick="fecharModalVideoBusy()">Fechar</button>
    </div>
  </div>
</div>
<div id="modalConfirmarEliminarBot" class="modal-overlay" style="display: none">
  <div class="modal-box modal-box-confirmacao">
    <p>Tem a certeza que quer eliminar este assistente virtual?</p>
    <div class="modal-buttons">
      <button id="btnConfirmarEliminarBot">Sim</button>
      <button id="btnCancelarEliminarBot">Cancelar</button>
    </div>
  </div>
</div>
<div id="modalCategorias" class="modal-overlay" style="display: none">
  <div
    class="modal-box modal-box-categorias-chatbot"
    style="max-height: 80vh; overflow-y: auto"
  >
    <h2>Gerir Categorias do Chatbot</h2>
    <div
      id="categoriasContainer"
      class="categorias-list"
      style="max-height: 320px; overflow-y: auto"
    ></div>
    <div
      class="btn-bar-categorias"
      style="display: flex; gap: 14px; margin-top: 18px"
    >
      <button onclick="fecharModalCategorias()" class="btn-fechar-categorias">
        Fechar
      </button>
    </div>
  </div>
</div>

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/AdicionarBot.js') }}"></script>
{% endblock %} {% endblock %}
